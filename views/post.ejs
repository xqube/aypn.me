<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('partials/head', { title, description, url, siteUrl }) %>
</head>

<body class="bg-surface text-content min-h-screen flex flex-col">
  <%- include('partials/header') %>

    <main class="flex-1 w-full max-w-7xl mx-auto px-4 sm:px-6 py-8 sm:py-12">
      <article class="lg:grid lg:grid-cols-[250px_minmax(0,1fr)_220px] lg:gap-10">

        <!-- Left sidebar: TOC -->
        <% if (toc && toc.length> 1) { %>
          <aside class="hidden lg:block">
            <nav class="lg:sticky lg:top-20 lg:max-h-[calc(100vh-6rem)] lg:overflow-y-auto"
              aria-label="Table of contents">
              <h2 class="font-mono text-xs text-muted uppercase tracking-widest mb-4">On this
                page</h2>
              <% var tree=[]; var currentH2=null; toc.forEach(function(item) { if (item.depth===2) { currentH2={ id:
                item.id, text: item.text, children: [] }; tree.push(currentH2); } else if (item.depth===3) { if
                (currentH2) { currentH2.children.push(item); } else { tree.push({ id: item.id, text: item.text,
                children: [] }); } } }); %>
                <ul class="toc-tree">
                  <% tree.forEach(function(h2) { %>
                    <li class="toc-item">
                      <a href="#<%= h2.id %>" class="toc-link">
                        <%= h2.text %>
                      </a>
                      <% if (h2.children.length> 0) { %>
                        <ul class="toc-subtree">
                          <% h2.children.forEach(function(h3) { %>
                            <li class="toc-item toc-sub">
                              <a href="#<%= h3.id %>" class="toc-link toc-link-sub">
                                <%= h3.text %>
                              </a>
                            </li>
                            <% }); %>
                        </ul>
                        <% } %>
                    </li>
                    <% }); %>
                </ul>
            </nav>
          </aside>
          <% } else { %>
            <!-- Empty left column when no TOC -->
            <div class="hidden lg:block"></div>
            <% } %>

              <!-- Mobile TOC -->
              <% if (toc && toc.length> 1) { %>
                <div class="lg:hidden mb-8">
                  <details class="toc-mobile">
                    <summary class="toc-mobile-toggle">
                      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
                      </svg>
                      <span>On this page</span>
                      <svg class="toc-chevron w-3 h-3 ml-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                      </svg>
                    </summary>
                    <nav class="mt-3" aria-label="Table of contents">
                      <ul class="toc-tree">
                        <% tree.forEach(function(h2) { %>
                          <li class="toc-item">
                            <a href="#<%= h2.id %>" class="toc-link">
                              <%= h2.text %>
                            </a>
                            <% if (h2.children.length> 0) { %>
                              <ul class="toc-subtree">
                                <% h2.children.forEach(function(h3) { %>
                                  <li class="toc-item toc-sub">
                                    <a href="#<%= h3.id %>" class="toc-link toc-link-sub">
                                      <%= h3.text %>
                                    </a>
                                  </li>
                                  <% }); %>
                              </ul>
                              <% } %>
                          </li>
                          <% }); %>
                      </ul>
                    </nav>
                  </details>
                </div>
                <% } %>

                  <!-- Post content (center column) -->
                  <div class="min-w-0">
                    <a href="<%= (typeof fromPage !== 'undefined' && fromPage) ? '/blog?page=' + fromPage : '/blog' %>"
                      class="inline-flex items-center gap-2 text-sm text-muted hover:text-accent border border-line hover:border-accent/40 rounded-full px-3.5 py-1.5 font-mono mb-8 transition-all duration-150">
                      <span class="text-base leading-none">&larr;</span> posts
                    </a>
                    <header class="mb-8">
                      <div class="flex items-baseline gap-3 flex-wrap mb-3">
                        <time datetime="<%= frontmatter.date %>" class="text-xs text-muted font-mono">
                          <%= new Date(frontmatter.date).toLocaleDateString('en-US', { year: 'numeric' , month: 'long' ,
                            day: 'numeric' }) %>
                        </time>
                        <% if (frontmatter.tags && frontmatter.tags.length> 0) { %>
                          <div class="flex gap-2">
                            <% frontmatter.tags.forEach(function(tag) { %>
                              <span class="text-xs font-mono text-accent/60">
                                <%= tag %>
                              </span>
                              <% }); %>
                          </div>
                          <% } %>
                      </div>
                      <h1 class="font-mono text-2xl sm:text-3xl font-semibold text-heading tracking-tight leading-snug">
                        <%= frontmatter.title %>
                      </h1>
                      <% if (frontmatter.description) { %>
                        <p class="text-muted mt-3 leading-relaxed">
                          <%= frontmatter.description %>
                        </p>
                        <% } %>
                    </header>

                    <div class="prose max-w-[85ch]">
                      <%- html %>
                    </div>

                    <!-- Reaction Bar -->
                    <div class="reaction-bar" id="reaction-bar" data-slug="<%= frontmatter.slug %>">
                      <div class="reaction-meta">
                        <span class="reaction-views" id="view-count">
                          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                              d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          </svg>
                          <span>
                            <%= typeof viewCount !=='undefined' ? viewCount : 0 %> views
                          </span>
                        </span>
                      </div>
                      <div class="reaction-buttons">
                        <button class="reaction-btn" data-type="üëç" aria-label="Like">
                          <span class="reaction-emoji">üëç</span>
                          <span class="reaction-count" id="count-üëç">0</span>
                        </button>
                        <button class="reaction-btn" data-type="üî•" aria-label="Fire">
                          <span class="reaction-emoji">üî•</span>
                          <span class="reaction-count" id="count-üî•">0</span>
                        </button>
                        <button class="reaction-btn" data-type="üí°" aria-label="Insightful">
                          <span class="reaction-emoji">üí°</span>
                          <span class="reaction-count" id="count-üí°">0</span>
                        </button>
                      </div>
                    </div>

                    <footer class="mt-12 pt-6 border-t border-line">
                      <a href="<%= (typeof fromPage !== 'undefined' && fromPage) ? '/blog?page=' + fromPage : '/blog' %>"
                        class="text-sm text-accent hover:text-accent-hover font-mono transition-colors duration-150">
                        &larr; all posts
                      </a>
                    </footer>
                  </div>

                  <!-- Right sidebar: Latest + Trending -->
                  <aside class="hidden lg:block">
                    <div class="lg:sticky lg:top-20 space-y-10 lg:max-h-[calc(100vh-6rem)] lg:overflow-y-auto">
                      <%- include('partials/sidebar', { latestPosts, trendingPosts }) %>
                    </div>
                  </aside>

      </article>

      <!-- Mobile: Latest & Trending below article -->
      <% if ((latestPosts && latestPosts.length> 0) || (trendingPosts && trendingPosts.length > 0)) { %>
        <div class="lg:hidden mt-10 pt-8 border-t border-line">
          <div class="grid grid-cols-2 gap-8">
            <%- include('partials/sidebar', { latestPosts, trendingPosts }) %>
          </div>
        </div>
        <% } %>

    </main>

    <%- include('partials/footer') %>

      <!-- Copy-to-clipboard for code blocks -->
      <script>
        (function () {
          document.querySelectorAll('.prose pre').forEach(function (pre) {
            // Wrap pre in a container so the button stays fixed over the viewport edge
            var wrap = document.createElement('div');
            wrap.className = 'code-copy-wrap';
            pre.parentNode.insertBefore(wrap, pre);
            wrap.appendChild(pre);

            var btn = document.createElement('button');
            btn.className = 'code-copy-btn';
            btn.setAttribute('aria-label', 'Copy code');
            btn.innerHTML = '<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';

            btn.addEventListener('click', function () {
              var code = pre.querySelector('code');
              var text = code ? code.innerText : pre.innerText;
              navigator.clipboard.writeText(text).then(function () {
                btn.innerHTML = '<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
                btn.classList.add('code-copy-btn--copied');
                setTimeout(function () {
                  btn.innerHTML = '<svg width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>';
                  btn.classList.remove('code-copy-btn--copied');
                }, 2000);
              });
            });

            wrap.appendChild(btn);
          });
        })();
      </script>

      <!-- TOC Active State Highlight -->
      <script>
        (function () {
          const headings = Array.from(document.querySelectorAll('.prose h2[id], .prose h3[id]'));
          const tocLinks = document.querySelectorAll('.toc-link, .toc-link-sub');

          if (headings.length === 0 || tocLinks.length === 0) return;

          // Remove active styles from all links
          const removeActive = () => {
            tocLinks.forEach(link => {
              link.classList.remove('text-accent', 'font-medium');
              link.className = link.className.replace(/!?text-accent/g, '').replace(/font-medium/g, '').trim();
            });
          };

          // Add active styles to a specific link
          const addActive = (id) => {
            removeActive();
            tocLinks.forEach(link => {
              if (link.getAttribute('href') === '#' + id) {
                link.className += ' text-accent font-medium';
              }
            });
          };

          const observerOptions = {
            root: null,
            rootMargin: '-100px 0px -60% 0px', // Trigger when header is near the top
            threshold: 1.0
          };

          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                addActive(entry.target.id);
              }
            });
          }, observerOptions);

          headings.forEach(heading => observer.observe(heading));

          // Fallback for page load or if user scrolls up past the first heading
          window.addEventListener('scroll', () => {
            if (window.scrollY < headings[0].offsetTop - 140) {
              removeActive();
              addActive(headings[0].id);
            }
          }, { passive: true });

          // Trigger initial state
          if (window.scrollY === 0) addActive(headings[0].id);

        })();
      </script>

      <!-- Reaction Bar Logic -->
      <script>
        (function () {
          var bar = document.getElementById('reaction-bar');
          if (!bar) return;
          var slug = bar.dataset.slug;

          // Load initial reaction counts
          fetch('/api/reactions/' + slug)
            .then(function (r) { return r.json(); })
            .then(function (data) {
              ['üëç', 'üî•', 'üí°'].forEach(function (type) {
                var el = document.getElementById('count-' + type);
                if (el && data[type] !== undefined) el.textContent = data[type];
              });
            })
            .catch(function () { /* graceful ‚Äî counts stay at 0 */ });

          // Handle reaction clicks
          var buttons = bar.querySelectorAll('.reaction-btn');
          buttons.forEach(function (btn) {
            btn.addEventListener('click', function () {
              var type = btn.dataset.type;
              var key = 'reacted:' + slug + ':' + type;

              // Prevent spam via localStorage (one reaction per type per post)
              if (localStorage.getItem(key)) {
                btn.classList.add('reaction-btn--already');
                setTimeout(function () { btn.classList.remove('reaction-btn--already'); }, 600);
                return;
              }

              // Animate
              btn.classList.add('reaction-btn--active');
              setTimeout(function () { btn.classList.remove('reaction-btn--active'); }, 400);

              fetch('/api/reactions/' + slug, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type })
              })
                .then(function (r) { return r.json(); })
                .then(function (data) {
                  ['üëç', 'üî•', 'üí°'].forEach(function (t) {
                    var el = document.getElementById('count-' + t);
                    if (el && data[t] !== undefined) el.textContent = data[t];
                  });
                  localStorage.setItem(key, '1');
                  btn.classList.add('reaction-btn--reacted');
                })
                .catch(function () { /* silent fail */ });
            });
          });

          // Restore reacted state from localStorage
          ['üëç', 'üî•', 'üí°'].forEach(function (type) {
            if (localStorage.getItem('reacted:' + slug + ':' + type)) {
              var btn = bar.querySelector('[data-type="' + type + '"]');
              if (btn) btn.classList.add('reaction-btn--reacted');
            }
          });
        })();
      </script>
</body>

</html>